name: Release

on:
  push:
    tags:
      - 'v*'

permissions:
  contents: write

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Download uv (Windows)
        run: |
          UV_VERSION=$(curl -s https://api.github.com/repos/astral-sh/uv/releases/latest | grep '"tag_name"' | sed 's/.*"tag_name": "\(.*\)".*/\1/')
          echo "uv version: $UV_VERSION"
          curl -L -o uv.zip "https://github.com/astral-sh/uv/releases/download/${UV_VERSION}/uv-x86_64-pc-windows-msvc.zip"
          mkdir -p tools/uv
          unzip uv.zip -d tools/uv/
          # Move binaries if nested in subdirectory
          if [ -d "tools/uv/uv-x86_64-pc-windows-msvc" ]; then
            mv tools/uv/uv-x86_64-pc-windows-msvc/* tools/uv/
            rmdir tools/uv/uv-x86_64-pc-windows-msvc
          fi
          # Add uv MIT license
          curl -L -o tools/uv/LICENSE-MIT "https://raw.githubusercontent.com/astral-sh/uv/main/LICENSE-MIT"

      - name: Download ffmpeg (Windows, LGPL)
        run: |
          curl -L -o ffmpeg.zip "https://github.com/BtbN/FFmpeg-Builds/releases/download/latest/ffmpeg-master-latest-win64-lgpl.zip"
          mkdir -p tools/ffmpeg
          unzip ffmpeg.zip -d /tmp/ffmpeg-extract/
          # Copy only the binaries we need
          cp /tmp/ffmpeg-extract/ffmpeg-master-latest-win64-lgpl/bin/ffmpeg.exe tools/ffmpeg/
          cp /tmp/ffmpeg-extract/ffmpeg-master-latest-win64-lgpl/bin/ffprobe.exe tools/ffmpeg/
          # Add ffmpeg license files
          cp /tmp/ffmpeg-extract/ffmpeg-master-latest-win64-lgpl/LICENSE.txt tools/ffmpeg/
          rm -rf /tmp/ffmpeg-extract ffmpeg.zip

      - name: Set version
        run: |
          if [ "$ACT" = "true" ]; then
            echo "VERSION=v0.0.0-local" >> $GITHUB_ENV
          else
            VERSION="${GITHUB_REF#refs/tags/}"
            if [ -z "$VERSION" ] || [ "$VERSION" = "$GITHUB_REF" ]; then
              echo "::error::Tag version not found in GITHUB_REF: $GITHUB_REF"
              exit 1
            fi
            echo "VERSION=$VERSION" >> $GITHUB_ENV
          fi

      - name: Create release package
        run: |
          PACKAGE_NAME="VoiceSlicer-${VERSION}-win64"

          # Create package directory
          mkdir -p "${PACKAGE_NAME}"

          # Copy project files (exclude dev/git files)
          cp -r src/ gui/ docs/ "${PACKAGE_NAME}/"
          cp transcribe.py split.py edit.py export_edit.py "${PACKAGE_NAME}/"
          cp run.bat "${PACKAGE_NAME}/"
          cp pyproject.toml uv.lock .python-version "${PACKAGE_NAME}/"
          cp README.md LICENSE "${PACKAGE_NAME}/"

          # Copy bundled tools
          cp -r tools/ "${PACKAGE_NAME}/"

          # Create zip
          zip -r "${PACKAGE_NAME}.zip" "${PACKAGE_NAME}/"

          echo "PACKAGE_NAME=${PACKAGE_NAME}" >> $GITHUB_ENV

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: ${{ env.PACKAGE_NAME }}
          path: ${{ env.PACKAGE_NAME }}.zip

      - name: Create GitHub Release
        if: env.ACT != 'true'
        uses: softprops/action-gh-release@v2
        with:
          files: ${{ env.PACKAGE_NAME }}.zip
          generate_release_notes: true
